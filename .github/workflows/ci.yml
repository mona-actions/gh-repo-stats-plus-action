name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract shell scripts from action.yml
        id: extract
        run: |
          mkdir -p /tmp/scripts
          # Extract run blocks from action.yml into individual scripts for linting
          python3 -c "
          import yaml, os
          with open('action.yml') as f:
              data = yaml.safe_load(f)
          steps = data.get('runs', {}).get('steps', [])
          for i, step in enumerate(steps):
              run_block = step.get('run')
              if run_block:
                  name = step.get('name', f'step-{i}').lower().replace(' ', '-')
                  path = f'/tmp/scripts/{i:02d}-{name}.sh'
                  with open(path, 'w') as out:
                      out.write('#!/usr/bin/env bash\n')
                      out.write(run_block)
                  print(f'Extracted: {path}')
          "

      - name: Run ShellCheck
        run: |
          if ls /tmp/scripts/*.sh 1>/dev/null 2>&1; then
            echo "Running ShellCheck on extracted scripts..."
            shellcheck --severity=warning /tmp/scripts/*.sh || true
          else
            echo "No shell scripts found to lint"
          fi

  yamllint:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Lint YAML files
        run: |
          pip install yamllint
          yamllint action.yml .github/workflows/*.yml .github/release-drafter.yml
